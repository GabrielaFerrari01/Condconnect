// Global Application State & Helpers
const CondConnect = {
    // Default Mock Products
    mockProducts: [
        {
            id: 'p1',
            title: 'IPhone 13 Pro Max 256GB',
            price: 'R$ 4.500,00',
            category: 'eletronicos',
            image: '/static/assets/images/celular.jpg',
            seller: 'Carlos Silva',
            location: 'Bloco A - Apto 101',
            description: 'iPhone em estado de novo, sem riscos. Acompanha caixa e carregador original.',
            condition: 'Seminovo'
        },
        {
            id: 'p2',
            title: 'Mesa de Jantar 6 Lugares',
            price: 'R$ 1.200,00',
            category: 'moveis',
            image: 'https://images.unsplash.com/photo-1577145745727-42b88d4de76d?q=80&w=500&auto=format&fit=crop',
            seller: 'Ana Beatriz',
            location: 'Bloco C - Apto 305',
            description: 'Mesa de madeira maciça em ótimo estado. Motivo: Mudança.',
            condition: 'Usado'
        },
        {
            id: 'p3',
            title: 'Bicicleta Mountain Bike',
            price: 'R$ 850,00',
            category: 'esportes',
            image: 'https://images.unsplash.com/photo-1485965120184-e220f721d03e?q=80&w=500&auto=format&fit=crop',
            seller: 'Marcos Oliveira',
            location: 'Bloco B - Apto 202',
            description: 'Bicicleta revisada mês passado. Aro 29.',
            condition: 'Usado'
        },
        {
            id: 'p4',
            title: 'Smart TV 55" 4K Samsung',
            price: 'R$ 2.100,00',
            category: 'eletronicos',
            image: 'https://images.unsplash.com/photo-1606813907291-d86efa9b94db?q=80&w=500&auto=format&fit=crop',
            seller: 'Ricardo Santos',
            location: 'Bloco A - Apto 504',
            description: 'TV con 1 ano de uso, impecável. Tenho a nota fiscal.',
            condition: 'Usado'
        }
    ],

    getProducts: function () {
        const userProducts = JSON.parse(localStorage.getItem('condconnect_user_products')) || [];
        const formattedUserProducts = userProducts.map(p => ({
            id: p.id,
            title: p.title,
            price: p.price.startsWith('R$') ? p.price : `R$ ${p.price}`,
            category: p.category.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""),
            image: p.image,
            seller: 'Você',
            location: 'Seu Apto',
            description: p.description,
            condition: p.condition
        }));

        return [...formattedUserProducts, ...this.mockProducts];
    },

    getProductById: function (id) {
        return this.getProducts().find(p => p.id === id);
    },

    // Central Favorites Logic
    syncHearts: function () {
        const favorites = JSON.parse(localStorage.getItem('condconnect_favorites')) || [];
        document.querySelectorAll('.product-card').forEach(card => {
            const likeBtn = card.querySelector('.like-btn');
            if (likeBtn) {
                const productId = likeBtn.getAttribute('data-id') ||
                    card.getAttribute('data-id') ||
                    card.getAttribute('href')?.split('=')[1];

                const isFav = favorites.some(f => (typeof f === 'string' ? f === productId : f.id === productId));

                if (isFav) {
                    likeBtn.style.color = '#ef4444';
                    likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
                } else {
                    likeBtn.style.color = '';
                    likeBtn.querySelector('svg').setAttribute('fill', 'none');
                }
            }
        });
    }
};

document.addEventListener('DOMContentLoaded', function () {
    console.log('CondConnect - Inicializado');

    // Initial sync
    CondConnect.syncHearts();

    // Event Delegation for Like Buttons (Centralized)
    document.addEventListener('click', function (e) {
        const likeBtn = e.target.closest('.like-btn');
        if (likeBtn) {
            e.preventDefault();
            e.stopPropagation();

            const card = likeBtn.closest('.product-card');
            if (!card) return;

            const productId = likeBtn.getAttribute('data-id') ||
                card.getAttribute('data-id') ||
                card.getAttribute('href')?.split('=')[1];

            if (!productId) return;

            let favorites = JSON.parse(localStorage.getItem('condconnect_favorites')) || [];
            const index = favorites.findIndex(f => (typeof f === 'string' ? f === productId : f.id === productId));

            if (index === -1) {
                const product = CondConnect.getProductById(productId);
                if (product) {
                    favorites.push(product);
                    likeBtn.style.color = '#ef4444';
                    likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
                }
            } else {
                favorites.splice(index, 1);
                likeBtn.style.color = '';
                likeBtn.querySelector('svg').setAttribute('fill', 'none');
            }

            localStorage.setItem('condconnect_favorites', JSON.stringify(favorites));
            window.dispatchEvent(new Event('storage'));
        }
    });

    // GLOBAL NOTIFICATIONS
    function updateNotificationBadges() {
        const conversations = JSON.parse(localStorage.getItem('condconnect_conversations')) || [];
        const totalUnread = conversations.reduce((sum, conv) => sum + (conv.unread || 0), 0);
        const msgNavItem = Array.from(document.querySelectorAll('.nav-item')).find(item => item.textContent.includes('Mensagens'));

        if (msgNavItem) {
            let badge = msgNavItem.querySelector('.notification-badge');
            if (totalUnread > 0) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.style.cssText = 'background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: auto;';
                    msgNavItem.appendChild(badge);
                }
                badge.textContent = totalUnread;
            } else if (badge) {
                badge.remove();
            }
        }
    }

    window.addEventListener('new_message', updateNotificationBadges);
    updateNotificationBadges();
});
